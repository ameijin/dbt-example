name: Production

on:
  push:
    branches: [main]

env:
  DBT_PROFILES_DIR: .

jobs:
  dbt-production:
    name: Full dbt build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Install dbt packages
        run: uv run dbt deps

      - name: Generate test data
        run: uv run python scripts/generate_test_data.py

      - name: Seed reference data
        run: uv run dbt seed

      - name: Full dbt build
        run: uv run dbt build

      - name: Generate docs
        run: uv run dbt docs generate

      - name: Upload manifest artifact
        uses: actions/upload-artifact@v4
        with:
          name: dbt-manifest
          path: target/manifest.json
          retention-days: 90

      - name: Upload docs catalog
        uses: actions/upload-artifact@v4
        with:
          name: dbt-docs
          path: |
            target/manifest.json
            target/catalog.json
            target/index.html
          retention-days: 90
